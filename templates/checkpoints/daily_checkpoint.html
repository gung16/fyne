{% extends 'base.html' %}

{% block page_title %}Daily Checkpoint{% endblock %}

{% block content %}
<!-- Camera Scan Interface -->
<div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 30px 20px 20px; text-align: center;">
    <div style="position: relative; width: 100%; max-width: 400px; height: 500px; background: linear-gradient(135deg, #FAFAFA, #F5F5F5); border-radius: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border-gray); overflow: hidden; margin-bottom: 30px;">
        <!-- Camera Preview Placeholder -->
        <div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: transparent;">
            <video id="cameraPreview" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; border-radius: 30px; background: #f8f8f8;"></video>
            <div id="cameraPrompt" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2;">
                <i class="fas fa-camera" style="font-size: 100px; color: var(--primary-medium); opacity: 0.3; margin-bottom: 25px;"></i>
                <p style="color: var(--text-medium); font-size: 17px; opacity: 0.7;">Ready for your close-up?<br>
                    <span style="font-size: 14px; color: var(--danger); display:none;" id="cameraError"></span>
                </p>
                <button type="button" id="startCameraBtn" onclick="requestCamera()" class="btn btn-secondary" style="margin-top:18px; font-size:15px;">Enable Camera</button>
            </div>
        </div>

        <script>
        let cameraStarted = false;
        async function requestCamera() {
            const video = document.getElementById('cameraPreview');
            const prompt = document.getElementById('cameraPrompt');
            const errorSpan = document.getElementById('cameraError');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: { facingMode: "user" }, audio: false});
                video.srcObject = stream;
                prompt.style.display = 'none';
                cameraStarted = true;
            } catch (err) {
                errorSpan.textContent = "Camera access denied or unavailable.";
                errorSpan.style.display = "block";
            }
        }

        // (Optional: Enable camera as soon as possible if permissions were already granted)
        document.addEventListener('DOMContentLoaded', function() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.permissions && navigator.permissions.query({name:'camera'})
                  .then(function(result) {
                      if(result.state === 'granted') {
                          requestCamera();
                      }
                  }).catch(function(){}); // silently ignore if API unsupported
            }
        });
        </script>
        
        <!-- Scanning Overlay -->
        <div id="scanOverlay" style="position: absolute; inset: 0; background: linear-gradient(180deg, transparent 0%, rgba(62, 30, 104, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s;"></div>
        
        <!-- Face Detection Guides -->
        <div style="position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; border-left: 3px solid var(--primary-dark); border-top: 3px solid var(--primary-dark); border-radius: 8px 0 0 0; opacity: 0.4;"></div>
        <div style="position: absolute; top: 30px; right: 30px; width: 50px; height: 50px; border-right: 3px solid var(--primary-dark); border-top: 3px solid var(--primary-dark); border-radius: 0 8px 0 0; opacity: 0.4;"></div>
        <div style="position: absolute; bottom: 30px; left: 30px; width: 50px; height: 50px; border-left: 3px solid var(--primary-dark); border-bottom: 3px solid var(--primary-dark); border-radius: 0 0 0 8px; opacity: 0.4;"></div>
        <div style="position: absolute; bottom: 30px; right: 30px; width: 50px; height: 50px; border-right: 3px solid var(--primary-dark); border-bottom: 3px solid var(--primary-dark); border-radius: 0 0 8px 0; opacity: 0.4;"></div>
    </div>
    
    <h2 style="color: var(--primary-dark); margin-bottom: 15px; font-size: 24px;">Smile! Capture Your Glow âœ¨</h2>
    <p style="color: var(--text-medium); font-size: 15px; margin-bottom: 30px; line-height: 1.6; max-width: 320px;">
        AI-powered skin analysis in seconds
    </p>
    
    <form method="post" id="scanForm" style="width: 100%; max-width: 380px;">
        {% csrf_token %}
        <button type="button" onclick="startScan()" class="btn btn-primary btn-block" id="scanBtn" style="padding: 18px; font-size: 16px;">
            <i class="fas fa-camera"></i> Start Scan
        </button>
    </form>
</div>

<script>
function startScan() {
    const btn = document.getElementById('scanBtn');
    const overlay = document.getElementById('scanOverlay');
    
    // Disable button and show scanning animation
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    overlay.style.opacity = '1';
    
    // Simulate AI processing time
    setTimeout(() => {
        // Submit the form to generate random values
        document.getElementById('scanForm').submit();
    }, 2000);
}
</script>

{% endblock %}
